name: "CI"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
 build:
     runs-on: ubuntu-22.04
     steps:
       - name: checkout code
         uses: actions/checkout@v3
         with:
           submodules: recursive false
 
       - name: Install system dependencies
         run: |
           sudo add-apt-repository universe
           sudo apt-get update
           sudo apt-get install -y darcs
 
       - name: Setup OCaml and OPAM
         uses: ocaml/setup-ocaml@v2
         with:
           ocaml-compiler: "4.14.1"
 
       - name: Retrieve the opam cache
         id: cache-ocaml
         uses: actions/cache@v3
         continue-on-error: true
         with:
           path: ~/.opam
           key: ${{ runner.os }}-opam-${{ hashFiles('**/opam.locked') }}
           restore-keys: |
             ${{ runner.os }}-opam-
 
       - name: Debug Search for coq-mathcomp
         run: |
           opam update
           opam search coq-mathcomp
         continue-on-error: true
 
       - name: Add Coq opam repository
         run: opam repo add coq-released https://coq.inria.fr/opam/released
 
       - name: Install Coq and dependencies
         run: |
           opam update
           eval "$(opam env)"
           opam install -y coq.8.18.0 coq-mathcomp-analysis dune
           eval "$(opam env)"
 
       - name: Verify dune installation
         run: dune --version
 
       - name: Build Coq project
         run: |
           eval "$(opam env)"
           dune build
       - name: Ensure dune is in PATH
         run: echo "$(opam var bin)" >> $GITHUB_PATH

       - name: Run Extraction
         run: |
           eval "$(opam env)"
           make extract